# Кэширующий SQLite-прокси для таблиц Power Query

Прозрачный кэш таблицы Power Query в локальной базе данных SQLite (далее - БД) с возможностью изменения существующих и дозагрузки новых данных. <code>Вы бесплатно получите инкрементальное обновление данных на своем Power BI Desktop!</code>
- база SQLite - это единственный файл с любым понятным вам названием и расширением, который можно синхронизировать с другими устройствами с помощью Яндекс диска, Google Drive и т.п.
- для прямого подключения к базе SQLite можно использовать, например, [SQLite ODBC Driver](http://www.ch-werner.de/sqliteodbc/) или скрипт, о котором сейчас идет речь

## Начало работы
1. Скачайте и установите python версии 3.x, если он у вас еще не установлен
1. В настройках Power BI проверьте ссылку на питон File > Options and settings > Options > Python scripting: Detected Python home directories
1. Скопируйте [исходный код скрипта](https://raw.githubusercontent.com/meta110/powerbi/master/sqliteproxy/pbi2sqlite.m) и вставьте его в пустой запрос

## Как пользоваться

### При первой загрузке, при обновлении и добавлении данных
1. Укажите полный путь к файлу базы данных, например: C:\Databases\database.sqlite. Название и расширение файла могут быть любыми. Важно, чтобы папка, в которой будет находится файл базы данных, существовала на вашем компьютере. Если укажите несуществующий путь, то возникнет ошибка (об ошибках ниже). Сам файл базы данных будет создан автоматически и вручную ничего создавать не нужно!
1. Укажите название таблицы, в которой будут храниться ваши данные. Название может быть любым понятным для вас. Внутри одной базы данных может быть много таблиц.
1. Укажите таблицу с данными, которые нужно поместить в базу данных. Крайне желательно, чтобы колонкам таблицы был присвоен корректный тип, т.к. он влияет на способ хранения данных внутри БД. Если тип колонок не будет задан, то все они станут текстовыми.
1. Укажите названия ключевых колонок таблицы в виде списка. Количество колонок не ограничено, но не меньше одной, например, колонка идентификатора строки. Важно чтобы значения в этой колонке (или наборе колонок) были уникальными, чтобы вы при необходимости могли изменить данные в остальных ячейках этой строки, адресуя строку по этим ключевым колонкам.

Переданная вами таблица поместится в базу данных и в результате вы получите всё содержимое базы данных. Таким образом можно периодически добавлять в БД новые порции данных и одновременно получать всё, что там имеется. Например, можно каждый день добавлять данные по расходам за вчерашний день в общую базу. При необходимости можно откорректировать данные за какие-то дни, передав в БД исправленные данные

### При получении существующих данных
1. Укажите полный путь к файлу БД
1. Укажите название таблицы

Остальные аргументы можно опустить. Вы получите все данные, которые есть в БД по указанным вами реквизитам

### Как удалить БД
Просто удалите файл базы данных.

Аргумент | Обязательный | Описание
---|---|---
DataBasePath | * | Ссылка на файл базы данных. Если файл не существует, то он будет создан автоматически
TableName | * | Название таблицы. Внутри базы данных может быть несколько таблиц. Если таблица не существует, то она будет создана автоматически
Data | - |  Таблица Power Query, которую нужно поместить в БД. Если указан null, то ничего возвращаться не будет
KeyColumns | - | Ключевые колонки. Список ключевых колонок из переданной таблицы (одна колонка с уникальными значениями или сочетание из нескольких колонок с уникальными значениями). Если таблица не передана ( Data = null ), то этот аргумент игнорируется. Если база не пустая, то список ключевых колонок обязателен.
RaiseError | - | Возбуждать ошибку при несоответствии данных. Если колонки в новой порции данных отличаются от имеющихся в таблице БД, возникнет ошибка. Можно принудительно пересоздать таблицу с новыми данными

## Сообщения о возможных ошибках
Во время работы вы можете столкнуться со следующими ошибками. Текст ошибки может немного отличаться, но смысл тот же самый
Ошибка | Как исправить
---|---
Указан путь к несуществующей папке с БД | Укажите путь к допустимой папке
Не передана никакая таблица с данными и БД не существует | Или передайте данные чтобы создать из них БД, или укажите путь к существующей БД
Колонки в новой порции данных отличаются от существующих в БД | Возможно, вы по ошибке пытаетесь поместить в таблицу данные, предназначенные для другой таблицы. Или укажите другое имя таблицы, или установите параметр RaiseError = false, чтобы существующая таблица была пересоздана с новыми данными
Указанные ключевые колонки отсутствуют в таблице | Вы указали ключевые колонки, которых нет в переданной вами таблице. Проверьте правильно ли указали колонки и сами данные

## Полезные ссылки
- [Страница скачивания Python](https://www.python.org/downloads/)
- [Страница скачивания SQLiteStudio](https://sqlitestudio.pl/)
- [Страница скачивания SQLite ODBC Driver](http://www.ch-werner.de/sqliteodbc/)
